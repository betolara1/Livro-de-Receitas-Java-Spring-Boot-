<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ranetech Receitas</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    
    <style>
        /* --- CSS (A Maquiagem do Site) --- */
        :root {
            --primary-color: #ff6b6b; /* Cor principal (Laranja/Vermelho comida) */
            --secondary-color: #4ecdc4;
            --bg-color: #f7f9fc;
            --text-color: #2d3436;
            --card-bg: #ffffff;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        /* Barra de Navega√ß√£o */
        nav {
            background-color: var(--card-bg);
            width: 100%;
            padding: 1rem 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-sizing: border-box;
        }

        .logo { font-weight: 600; font-size: 1.5rem; color: var(--primary-color); }
        
        .nav-buttons button {
            margin-left: 10px;
            cursor: pointer;
            padding: 8px 16px;
            border: none;
            border-radius: 20px;
            font-weight: 500;
            transition: 0.3s;
        }

        .btn-login { background-color: transparent; border: 2px solid var(--primary-color); color: var(--primary-color); }
        .btn-logout { background-color: #fab1a0; color: white; }
        .btn-primary { background-color: var(--primary-color); color: white; }
        
        button:hover { transform: translateY(-2px); opacity: 0.9; }

        /* Container Principal */
        .container {
            width: 90%;
            max-width: 800px;
            margin-top: 2rem;
        }

        /* Telas (Login, Cadastro, Lista) - Escondidas por padr√£o */
        .screen { display: none; animation: fadeIn 0.5s; }
        .active { display: block; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Formul√°rios */
        .form-card {
            background: var(--card-bg);
            padding: 2rem;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            max-width: 400px;
            margin: 0 auto;
        }

        input, textarea {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #dfe6e9;
            border-radius: 8px;
            box-sizing: border-box; /* Garante que padding n√£o estoure a largura */
        }

        /* Lista de Receitas (Cards) */
        .recipe-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
        }

        .recipe-card {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 1.5rem;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
            position: relative;
        }

        .recipe-card h3 { margin-top: 0; color: var(--primary-color); }
        .recipe-card small { color: #b2bec3; display: block; margin-bottom: 10px; }
        
        .delete-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #ff7675;
            color: white;
            border: none;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 12px;
        }

        .edit-btn {
            position: absolute;
            top: 10px;
            right: 40px;
            background: var(--secondary-color);
            color: white;
            border: none;
            width: 30px;
            height: 25px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 11px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }
    </style>
</head>
<body>

    <nav>
        <div class="logo">Ranetech üç≥</div>
        <div class="nav-buttons" id="nav-btns">
            </div>
    </nav>

    <div class="container">

        <div id="screen-login" class="screen active">
            <div class="form-card">
                <h2 style="text-align: center;">Bem-vindo de volta!</h2>
                <input type="text" id="login-user" placeholder="Usu√°rio">
                <input type="password" id="login-pass" placeholder="Senha">
                <button class="btn-primary" style="width: 100%;" onclick="fazerLogin()">Entrar</button>
                <p style="text-align: center; font-size: 0.9rem;">
                    N√£o tem conta? <a href="#" onclick="showScreen('register')">Cadastre-se</a>
                </p>
            </div>
        </div>

        <div id="screen-register" class="screen">
            <div class="form-card">
                <h2 style="text-align: center;">Criar Conta</h2>
                <input type="text" id="reg-user" placeholder="Escolha um usu√°rio">
                <input type="password" id="reg-pass" placeholder="Escolha uma senha">
                <button class="btn-primary" style="width: 100%;" onclick="fazerCadastro()">Cadastrar</button>
                <p style="text-align: center; font-size: 0.9rem;">
                    J√° tem conta? <a href="#" onclick="showScreen('login')">Fazer Login</a>
                </p>
            </div>
        </div>

        <div id="screen-dashboard" class="screen">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2>Minhas Receitas</h2>
                <button class="btn-primary" onclick="showScreen('add-recipe')">+ Nova Receita</button>
            </div>
            
            <div id="recipes-list" class="recipe-grid">
                <p>Carregando...</p>
            </div>
        </div>

        <div id="screen-add-recipe" class="screen">
            <div class="form-card" style="max-width: 600px;">
                <h2>Nova Receita</h2>
                <input type="text" id="new-title" placeholder="T√≠tulo (ex: Bolo de Cenoura)">
                <textarea id="new-desc" placeholder="Descri√ß√£o (ex: Fofinho com cobertura...)" rows="3"></textarea>
                
                <!-- Ingredientes (cada item com bot√£o +) -->
                <div style="margin-top: 10px;">
                    <label><strong>Ingredientes</strong></label>
                    <div style="display: flex; gap: 8px; margin-top: 5px; flex-wrap: wrap;">
                        <input type="text" id="new-ingredient-item" placeholder="Ex: Farinha de trigo" style="flex: 2;">
                        <input type="text" id="new-ingredient-qty" placeholder="Ex: 2 x√≠caras" style="flex: 1;">
                        <button type="button" class="btn-primary" onclick="adicionarIngrediente()" style="white-space: nowrap;">+ Ingrediente</button>
                    </div>
                    <ul id="ingredients-list" style="margin-top: 8px; padding-left: 18px;"></ul>
                </div>

                <!-- Instru√ß√µes (cada passo com bot√£o +) -->
                <div style="margin-top: 15px;">
                    <label><strong>Instru√ß√µes / Passos</strong></label>
                    <div style="display: flex; gap: 8px; margin-top: 5px; flex-wrap: wrap;">
                        <input type="text" id="new-instruction-text" placeholder="Ex: Misture os ingredientes secos" style="flex: 1;">
                        <button type="button" class="btn-primary" onclick="adicionarInstrucao()" style="white-space: nowrap;">+ Passo</button>
                    </div>
                    <ol id="instructions-list" style="margin-top: 8px; padding-left: 18px;"></ol>
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button class="btn-primary" style="flex: 1;" onclick="salvarReceita()">Salvar</button>
                    <button style="flex: 1; background: #dfe6e9; border: none; border-radius: 20px; cursor: pointer;" onclick="showScreen('dashboard')">Cancelar</button>
                </div>
            </div>
        </div>

    </div>

    <script>
        /* --- JAVASCRIPT (O C√©rebro) --- */
        
        const API_URL = "http://localhost:8080"; 
        let tokenBasicGlobal = null; // guarda o usu√°rio logado atual

        // listas tempor√°rias usadas na tela de cria√ß√£o
        let ingredientesTemp = [];
        let instrucoesTemp = [];
        let receitaEditandoId = null; // guarda o ID da receita sendo editada (null = criando nova)

        // 1. Gerenciador de Telas (Simples SPA)
        function showScreen(screenName) {
            // Esconde todas
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            // Mostra a escolhida
            document.getElementById(`screen-${screenName}`).classList.add('active');
            
            // Atualiza bot√µes do menu
            updateNav(screenName);

            // quando abrir tela de nova receita, limpa listas tempor√°rias e UI
            if (screenName === 'add-recipe') {
                // Se n√£o estiver editando, limpa tudo (modo cria√ß√£o)
                if (receitaEditandoId === null) {
                    ingredientesTemp = [];
                    instrucoesTemp = [];
                    renderIngredientes();
                    renderInstrucoes();
                    document.getElementById('new-title').value = '';
                    document.getElementById('new-desc').value = '';
                    document.getElementById('new-ingredient-item').value = '';
                    document.getElementById('new-ingredient-qty').value = '';
                    document.getElementById('new-instruction-text').value = '';
                    document.querySelector('#screen-add-recipe h2').textContent = 'Nova Receita';
                    document.querySelector('#screen-add-recipe button.btn-primary').textContent = 'Salvar';
                }
            }
        }

        function updateNav(screenName) {
            const nav = document.getElementById('nav-btns');
            if (screenName === 'login' || screenName === 'register') {
                nav.innerHTML = ''; // Limpa menu se n√£o tiver logado
            } else {
                nav.innerHTML = `<button class="btn-logout" onclick="fazerLogout()">Sair</button>`;
            }
        }

        // 2. FUN√á√ÉO DE CADASTRO
        async function fazerCadastro() {
            const user = document.getElementById('reg-user').value;
            const pass = document.getElementById('reg-pass').value;

            // Chama seu Backend: /auth/register
            const response = await fetch(`${API_URL}/auth/register`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username: user, password: pass })
            });

            if (response.ok) {
                alert("Conta criada! Agora fa√ßa login.");
                showScreen('login');
            } else {
                alert("Erro ao criar conta. Tente outro nome.");
            }
        }

        // 3. FUN√á√ÉO DE LOGIN (A M√°gica do Basic Auth)
        async function fazerLogin() {
            const user = document.getElementById('login-user').value;
            const pass = document.getElementById('login-pass').value;

            // Transforma usuario:senha em Base64 (Padr√£o Basic Auth)
            const tokenBasic = btoa(`${user}:${pass}`);

            // Tenta buscar as receitas para testar a senha
            const response = await fetch(`${API_URL}/api/receitas`, {
                method: 'GET',
                headers: {
                    'Authorization': `Basic ${tokenBasic}` // <--- Aqui enviamos a senha
                }
            });

            if (response.status === 200) {
                // guarda o token do usu√°rio logado para usar nas demais chamadas
                tokenBasicGlobal = tokenBasic;
                showScreen('dashboard');
                carregarReceitas();
            } else {
                alert("Usu√°rio ou senha incorretos!");
            }
        }

        // Helpers para montar listas de ingredientes/instru√ß√µes na tela de cadastro
        function renderIngredientes() {
            const ul = document.getElementById('ingredients-list');
            ul.innerHTML = '';
            ingredientesTemp.forEach((ing, idx) => {
                const li = document.createElement('li');
                li.textContent = ing.quantity ? `${ing.item} (${ing.quantity})` : ing.item;
                li.style.cursor = 'pointer';
                li.title = 'Clique para remover';
                li.onclick = () => {
                    ingredientesTemp.splice(idx, 1);
                    renderIngredientes();
                };
                ul.appendChild(li);
            });
        }

        function renderInstrucoes() {
            const ol = document.getElementById('instructions-list');
            ol.innerHTML = '';
            instrucoesTemp.forEach((txt, idx) => {
                const li = document.createElement('li');
                li.textContent = txt;
                li.style.cursor = 'pointer';
                li.title = 'Clique para remover';
                li.onclick = () => {
                    instrucoesTemp.splice(idx, 1);
                    renderInstrucoes();
                };
                ol.appendChild(li);
            });
        }

        function adicionarIngrediente() {
            const item = document.getElementById('new-ingredient-item').value.trim();
            const qty = document.getElementById('new-ingredient-qty').value.trim();
            if (!item) return;
            ingredientesTemp.push({ item: item, quantity: qty });
            document.getElementById('new-ingredient-item').value = '';
            document.getElementById('new-ingredient-qty').value = '';
            renderIngredientes();
        }

        function adicionarInstrucao() {
            const txt = document.getElementById('new-instruction-text').value.trim();
            if (!txt) return;
            instrucoesTemp.push(txt);
            document.getElementById('new-instruction-text').value = '';
            renderInstrucoes();
        }

        // 4. CARREGAR RECEITAS (GET)
        async function carregarReceitas() {
            const container = document.getElementById('recipes-list');
            container.innerHTML = '<p>Buscando receitas...</p>';

            // Agora sempre mandamos o Basic do usu√°rio logado
            const response = await fetch(`${API_URL}/api/receitas`, {
                method: 'GET',
                headers: tokenBasicGlobal ? { 'Authorization': `Basic ${tokenBasicGlobal}` } : {}
            });
            
            if (response.ok) {
                const lista = await response.json();
                container.innerHTML = ''; // Limpa

                if (lista.length === 0) {
                    container.innerHTML = '<p>Voc√™ ainda n√£o tem receitas.</p>';
                    return;
                }

                // Cria o HTML de cada receita
                lista.forEach(receita => {
                    // formata ingredientes e instru√ß√µes de forma amig√°vel
                    const ingredientsText = Array.isArray(receita.ingredients)
                        ? receita.ingredients.map(ing => {
                            if (ing && typeof ing === 'object') {
                                const nome = ing.item || ing.nome || '';
                                const qtd = ing.quantity || ing.qtd || ing.quantidade || '';
                                return qtd ? `${nome} (${qtd})` : nome;
                            }
                            return ing || '';
                        }).filter(Boolean).join(', ')
                        : (receita.ingredients || '...');

                    const instructionsText = Array.isArray(receita.instructions)
                        ? receita.instructions.filter(Boolean).join(' | ')
                        : (receita.instructions || '...');

                    const card = document.createElement('div');
                    card.className = 'recipe-card';
                    card.innerHTML = `
                        <button class="delete-btn" onclick="deletarReceita(${receita.id})" title="Deletar">X</button>
                        <button class="edit-btn" onclick="editarReceita(${receita.id})" title="Editar">‚úé</button>
                        <h3>${receita.title}</h3>
                        <small>Autor: ${receita.nomeDoAutor || 'Voc√™'}</small>
                        <p>${receita.description}</p>
                        <hr style="border: 0; border-top: 1px solid #eee;">
                        <details>
                            <summary style="cursor: pointer; color: var(--secondary-color);">Ver Detalhes</summary>
                            <p><strong>Ingredientes:</strong> ${ingredientsText}</p>
                            <p><strong>Modo de Preparo:</strong> ${instructionsText}</p>
                        </details>
                    `;
                    container.appendChild(card);
                });
            } else {
                alert("Sess√£o expirada. Fa√ßa login novamente.");
                showScreen('login');
            }
        }

        // 5. FUN√á√ÉO PARA EDITAR RECEITA (Carrega dados na tela)
        async function editarReceita(id) {
            receitaEditandoId = id;
            
            try {
                // Busca a receita pelo ID
                const response = await fetch(`${API_URL}/api/receitas/${id}`, {
                    method: 'GET',
                    headers: tokenBasicGlobal ? { 'Authorization': `Basic ${tokenBasicGlobal}` } : {}
                });

                if (!response.ok) {
                    alert("Erro ao carregar receita para edi√ß√£o.");
                    return;
                }

                const receita = await response.json();
                
                // Preenche os campos
                document.getElementById('new-title').value = receita.title || '';
                document.getElementById('new-desc').value = receita.description || '';
                
                // Preenche ingredientes
                ingredientesTemp = Array.isArray(receita.ingredients) ? receita.ingredients : [];
                renderIngredientes();
                
                // Preenche instru√ß√µes
                instrucoesTemp = Array.isArray(receita.instructions) ? receita.instructions : [];
                renderInstrucoes();
                
                // Muda o t√≠tulo da tela e o texto do bot√£o
                document.querySelector('#screen-add-recipe h2').textContent = 'Editar Receita';
                document.querySelector('#screen-add-recipe button.btn-primary').textContent = 'Atualizar';
                
                // Mostra a tela de edi√ß√£o
                showScreen('add-recipe');
                
            } catch (error) {
                console.error('Erro ao carregar receita:', error);
                alert("Erro ao carregar receita para edi√ß√£o.");
            }
        }

        // 6. SALVAR/ATUALIZAR RECEITA (POST ou PUT)
        async function salvarReceita() {
            const title = document.getElementById('new-title').value;
            const desc = document.getElementById('new-desc').value;
            
            if (!title.trim()) {
                alert("Por favor, preencha o t√≠tulo da receita.");
                return;
            }
            
            // usa as listas montadas pelos bot√µes "+"
            const ingredients = ingredientesTemp;
            const instructions = instrucoesTemp;

            const receitaObj = {
                title: title,
                description: desc,
                ingredients: ingredients,
                instructions: instructions
            };

            // Se estiver editando, faz PUT. Sen√£o, faz POST
            const isEditando = receitaEditandoId !== null;
            const url = isEditando ? `${API_URL}/api/receitas/${receitaEditandoId}` : `${API_URL}/api/receitas`;
            const method = isEditando ? 'PUT' : 'POST';

            const response = await fetch(url, {
                method: method,
                headers: Object.assign(
                    { 'Content-Type': 'application/json' },
                    tokenBasicGlobal ? { 'Authorization': `Basic ${tokenBasicGlobal}` } : {}
                ),
                body: JSON.stringify(receitaObj)
            });

            if (response.ok) {
                alert(isEditando ? "Receita Atualizada!" : "Receita Salva!");
                // Limpa tudo
                receitaEditandoId = null;
                ingredientesTemp = [];
                instrucoesTemp = [];
                document.getElementById('new-title').value = '';
                document.getElementById('new-desc').value = '';
                document.getElementById('new-ingredient-item').value = '';
                document.getElementById('new-ingredient-qty').value = '';
                document.getElementById('new-instruction-text').value = '';
                showScreen('dashboard');
                carregarReceitas(); // Atualiza a lista
            } else {
                const errorText = await response.text();
                alert(`Erro ao ${isEditando ? 'atualizar' : 'salvar'}: ${errorText}`);
            }
        }

        // 7. DELETAR (DELETE)
        async function deletarReceita(id) {
            if (confirm("Tem certeza que quer apagar?")) {
                await fetch(`${API_URL}/api/receitas/${id}`, { 
                    method: 'DELETE',
                    headers: tokenBasicGlobal ? { 'Authorization': `Basic ${tokenBasicGlobal}` } : {}
                });
                carregarReceitas(); // Atualiza a tela
            }
        }

        function fazerLogout() {
            // "Esquece" o usu√°rio logado atual no front
            tokenBasicGlobal = null;
            // Recarrega a p√°gina para limpar a mem√≥ria do JS
            window.location.reload();
        }

    </script>
</body>
</html>